---
import BaseLayout from '../../layouts/BaseLayout.astro';
import projects from '../../data/projects.json';

export function getStaticPaths() {
  return projects.map(project => ({
    params: { slug: project.slug },
    props: { project }
  }));
}

const { project } = Astro.props;
const currentIndex = projects.indexOf(project);
const prevProject = currentIndex > 0 ? projects[currentIndex - 1] : null;
const nextProject = projects[(currentIndex + 1) % projects.length];
const heroMedia = project.hero || project.thumbnail;
const hasThumb = heroMedia && heroMedia.length > 0;
const isVideo = hasThumb && /\.(mp4|webm|mov)$/i.test(heroMedia);
---

<BaseLayout title={`${project.title} — Explicit Studio`}>
  <article class="project-page">
    <!-- Hero image -->
    <div class="project-page__hero-image" style={`background-color: ${project.cardBg || '#1E1E1E'};`}>
      {isVideo ? (
        <video src={heroMedia} autoplay muted loop playsinline />
      ) : hasThumb ? (
        <img src={heroMedia} alt={project.title} />
      ) : (
        <span class="project-page__hero-placeholder">{project.title}</span>
      )}
    </div>

    <!-- Title + subtitle -->
    <h1 class="project-page__title">{project.title}</h1>
    <p class="project-page__subtitle">{project.subtitle}</p>

    <!-- Details bar -->
    <div class="project-details">
      <div>
        <p class="project-details__label">Client</p>
        <p class="project-details__value">{project.client}</p>
      </div>
      <div>
        <p class="project-details__label">Industry</p>
        <p class="project-details__value">{project.industry}</p>
      </div>
      <div>
        <p class="project-details__label">Services</p>
        <p class="project-details__value">{project.tags.join(', ')}</p>
      </div>
      <div>
        <p class="project-details__label">Year</p>
        <p class="project-details__value">{project.year}</p>
      </div>
      <div>
        <p class="project-details__label">Result</p>
        <p class="project-details__value">{project.metric || '—'}</p>
      </div>
    </div>

    <!-- Case study sections -->
    {project.sections && project.sections.map((section, i) => (
      <div class="project-page__section">
        {section.label && (
          <p class="project-page__label">{section.label.charAt(0) + section.label.slice(1).toLowerCase()}</p>
        )}
        {section.text && (
          <div class="project-page__body">
            {section.text.split('\n\n').map(p => <p>{p}</p>)}
          </div>
        )}
        {section.image && typeof section.image === 'string' && (
          <div class="project-page__full-image">
            <img src={section.image} alt={project.title} />
          </div>
        )}
        {section.image && section.image === true && (
          <div class="project-page__full-image placeholder">
            {project.title} — Image {i + 1}
          </div>
        )}
        {section.imageGrid && Array.isArray(section.imageGrid) && (
          <div class="project-page__image-grid">
            <img src={section.imageGrid[0]} alt={`${project.title} — A`} />
            <img src={section.imageGrid[1]} alt={`${project.title} — B`} />
          </div>
        )}
        {section.imageGrid && section.imageGrid === true && (
          <div class="project-page__image-grid">
            <div class="placeholder">{project.title} — Grid Image A</div>
            <div class="placeholder">{project.title} — Grid Image B</div>
          </div>
        )}
      </div>
    ))}

    {!project.sections && (
      <div class="project-page__section">
        <div class="project-page__body">
          <p>{project.year.includes('Ongoing') ? 'Ongoing Project' : project.subtitle}</p>
        </div>
      </div>
    )}

    <!-- Prev / Next project -->
    <div class="project-page__nav">
      <div class="project-page__nav-prev">
        {prevProject && (
          <a href={`/work/${prevProject.slug}`}>
            <span class="arrow">&larr;</span> {prevProject.title}
          </a>
        )}
      </div>
      <div class="project-page__nav-next">
        <a href={`/work/${nextProject.slug}`}>
          {nextProject.title} <span class="arrow">&rarr;</span>
        </a>
      </div>
    </div>
  </article>
</BaseLayout>

<script>
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
        }
      });
    },
    { threshold: 0.1 }
  );

  document.querySelectorAll('.reveal, .project-page').forEach((el) => {
    observer.observe(el);
  });
</script>
